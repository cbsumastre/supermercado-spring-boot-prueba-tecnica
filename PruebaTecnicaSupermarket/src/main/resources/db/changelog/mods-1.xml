<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.27.xsd">

  <changeSet id="1" author="cbsumastre">
    <createTable tableName="SUCURSAL">
      <column name="id" type="BIGINT" autoIncrement="true">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="nombre" type="VARCHAR(200)">
        <constraints nullable="false"/>
      </column>
      <column name="direccion" type="VARCHAR(200)">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet id="2" author="cbsumastre">
    <sqlFile path="data/insert-sucursales.sql" relativeToChangelogFile="true" splitStatements="true" stripComments="true" encoding="UTF-8"/>
  </changeSet>

  <changeSet id="3" author="cbsumastre">
    <createTable tableName="CATEGORIA">
      <column name="id" type="VARCHAR(200)">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="descripcion" type="VARCHAR(200)">
        <constraints nullable="false"/>
      </column>
    </createTable>
  </changeSet>

  <changeSet id="4" author="cbsumastre">
    <sqlFile path="db/changelog/data/insert-categorias-producto.sql" relativeToChangelogFile="false" splitStatements="true" stripComments="true" encoding="UTF-8"/>
  </changeSet>


  <changeSet id="5" author="cbsumastre">
    <createTable tableName="PRODUCTO">
      <column name="id" type="BIGINT" autoIncrement="true">
        <constraints primaryKey="true"/>
      </column>
      <column name="nombre" type="VARCHAR(200)">
        <constraints nullable="false"/>
      </column>
      <column name="categoria_id" type="VARCHAR(200)">
        <constraints nullable="false"/>
      </column>
      <column name="stock" type="INT" defaultValueNumeric="0">
        <constraints nullable="false"/>
      </column>
      <column name="precio" type="DOUBLE">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <addForeignKeyConstraint baseTableName="producto" baseColumnNames="categoria_id" constraintName="fk_producto_categoria" referencedTableName="categoria" referencedColumnNames="id" />
  </changeSet>

  <changeSet id="6" author="cbsumastre">
    <sqlFile path="data/insert-productos.sql" relativeToChangelogFile="true" splitStatements="true" stripComments="true" encoding="UTF-8" />
  </changeSet>

  <changeSet id="7" author="cbsumastre">
    <createTable tableName="VENTA">
      <column name="id" type="BIGINT" autoIncrement="true">
        <constraints primaryKey="true"/>
      </column>
      <column name="fecha" type="DATETIME">
        <constraints nullable="false"/>
      </column>
      <column name="estado" type="VARCHAR(50)">
        <constraints nullable="false"/>
      </column>

      <column name="sucursal_id" type="BIGINT">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <addForeignKeyConstraint baseTableName="VENTA" baseColumnNames="sucursal_id" constraintName="fk_venta_sucursal" referencedTableName="SUCURSAL" referencedColumnNames="id" onDelete="RESTRICT" />
  </changeSet>

  <changeSet id="8" author="cbsumastre">
    <sqlFile path="data/insert-ventas.sql" relativeToChangelogFile="true" splitStatements="true" stripComments="true" encoding="UTF-8"/>
  </changeSet>

  <changeSet id="9" author="cbsumastre">
    <createTable tableName="DETALLE_VENTA">
      <column name="id" type="BIGINT" autoIncrement="true">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="venta_id" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="producto_id" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="cantidad" type="INT">
        <constraints nullable="false"/>
      </column>
      <column name="precio" type="DOUBLE">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <addForeignKeyConstraint baseTableName="DETALLE_VENTA" baseColumnNames="venta_id" constraintName="fk_venta_detalle_venta" referencedTableName="VENTA" referencedColumnNames="id" onDelete="RESTRICT"/>
    <addForeignKeyConstraint baseTableName="DETALLE_VENTA" baseColumnNames="producto_id" constraintName="fk_venta_detalle_producto" referencedTableName="PRODUCTO" referencedColumnNames="id" onDelete="RESTRICT"/>
  </changeSet>

  <changeSet id="10" author="cbsumastre">
    <sqlFile path="data/insert-detalle-ventas.sql" relativeToChangelogFile="true" splitStatements="true" stripComments="true" encoding="UTF-8"/>
  </changeSet>


  <changeSet id="11" author="cbsumastre">
    <addColumn tableName="VENTA">
      <column name="TOTAL" type="DOUBLE" defaultValueNumeric="0">
        <constraints nullable="true"/>
      </column>
    </addColumn>
    <sql>
      <![CDATA[ 
          UPDATE VENTA
          SET total = (
          -- La subconsulta calcula la suma total para la VENTA actual (referenciada por VENTA.id)
          SELECT 
              SUM(dv.cantidad * dv.precio)
          FROM 
              DETALLE_VENTA dv
          -- Correlación: solo suma los detalles que corresponden a la VENTA que se está actualizando
          WHERE 
              dv.venta_id = VENTA.id);
          UPDATE VENTA SET TOTAL=0 WHERE TOTAL IS NULL;
      ]]>
    </sql>

    <addNotNullConstraint tableName="VENTA" columnName="TOTAL" columnDataType="DOUBLE" />

  </changeSet>


</databaseChangeLog>